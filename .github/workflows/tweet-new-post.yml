# ワークフローの名称
name: Tweet New Post

# ワークフローが実行されるタイミングを定義
on:
  workflow_dispatch:
  # pushイベントに反応
  push:
    # どのブランチへのpushを監視するか
    branches:
      - main
    # どのファイルパスの変更を監視するか
    paths:
      - '_posts/**.md' # _postsディレクトリ以下のマークダウンファイルが対象

# 実行されるジョブを定義
jobs:
  # 'detect-changes' という名前のジョブ。変更されたファイルを検出する。
  detect-changes:
    # ジョブを実行する仮想環境の種類
    runs-on: ubuntu-latest
    # このジョブの出力を定義
    outputs:
      # 'posts'という名前の出力。JSON文字列形式のファイルリストを格納する。
      posts: ${{ steps.get_posts.outputs.posts }}
    
    # ジョブ内で実行される一連のステップ
    steps:
      # ステップ1: リポジトリのチェックアウト
      - name: Check out repository
        # GitHub公式のアクションを利用して、リポジトリのコードを仮想環境にコピーする
        uses: actions/checkout@v4
        with:
          # git fetchの深さを指定。2にすることで、最新とその1つ前のコミット履歴を取得する
          # これにより、HEAD~1 と HEAD の差分を比較できるようになる
          fetch-depth: 2 # 直前のコミットと比較するために、最新2件のコミットを取得します

      # ステップ2: 変更された投稿ファイルを取得
      - name: Get modified post files
        # このステップにIDを付与し、後続のステップから出力（outputs）を参照できるようにする
        id: get_posts
        # 実行するシェルコマンド
        run: |
          # git diffコマンドで、最新のコミット(HEAD)と1つ前のコミット(HEAD~1)の差分を調べる
          # --name-onlyで変更があったファイル名のみを出力し、grepで_postsディレクトリ以下の.mdファイルに絞り込む
          # jqコマンドで、結果をJSON配列に変換する
          POST_FILES=$(git diff --name-only HEAD~1 HEAD | grep "_posts/.*\.md$" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "Found posts: ${POST_FILES}"
          # 'posts'という名前で、JSON配列形式のファイルリストを出力に設定
          echo "posts=${POST_FILES}" >> $GITHUB_OUTPUT

  # 'tweet'という名前のジョブ。各投稿をツイートする。
  tweet:
    # このジョブは'detect-changes'ジョブが正常に完了した後に実行される
    needs: detect-changes
    # 'detect-changes'ジョブの出力が空の配列 '[]' でない場合のみ、このジョブを実行する
    if: needs.detect-changes.outputs.posts != '[]'
    # ジョブを実行する仮想環境の種類
    runs-on: ubuntu-latest
    # strategy: matrix を使い、複数のジョブを並列実行する
    strategy:
      # 'detect-changes'ジョブの出力（JSON配列）を元に、動的な実行計画を作成する
      matrix:
        # 'post_path'という変数を定義し、ファイルパスの配列を展開する
        post_path: ${{ fromJson(needs.detect-changes.outputs.posts) }}

    # ジョブ内で実行される一連のステップ
    steps:
      # ステップ1: リポジトリのチェックアウト
      - name: Check out repository
        # 各Matrixジョブでコードが必要なため、再度チェックアウトする
        uses: actions/checkout@v4

      # ステップ2: Pythonのセットアップ
      - name: Set up Python
        # actions/setup-python@v5 を利用してPython環境を構築
        uses: actions/setup-python@v5
        with:
          # Pythonのバージョンを指定
          python-version: '3.10'

      # ステップ3: Python依存ライブラリのインストール
      - name: Install Python dependencies
        # pipコマンドで、pyyamlとtweepyライブラリをインストール
        run: pip install pyyaml tweepy

      # ステップ4: ツイート本文の準備
      - name: Prepare Tweet Text
        # このステップにIDを付与
        id: prepare_tweet
        # 指定されたPythonスクリプトを実行
        run: python .github/scripts/prepare_tweet.py
        # スクリプトに渡す環境変数を設定
        env:
          # LATEST_POST_FILEという環境変数名で、Matrixで展開された現在のファイルパスを渡す
          LATEST_POST_FILE: ${{ matrix.post_path }}

      # ステップ5: ツイートの投稿 (API v2を使用)
      - name: Post Tweet (using API v2)
        # 実行条件: ステップ4('prepare_tweet')で'tweet_text'という出力が生成されている
        if: steps.prepare_tweet.outputs.tweet_text
        # 新しく作成したPythonスクリプトを実行
        run: python .github/scripts/post_tweet.py
        env:
          # GitHub Secretsから認証情報を取得して環境変数として設定
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_KEY_SECRET: ${{ secrets.TWITTER_API_KEY_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
          # ステップ4で生成されたツイート本文を環境変数として渡す
          TWEET_TEXT: ${{ steps.prepare_tweet.outputs.tweet_text }}
